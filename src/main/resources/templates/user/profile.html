<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8">
    <title>个人中心 - 书籍管理系统</title>
    <link rel="stylesheet" th:href="@{/css/style.css}">
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
          rel="stylesheet"
          integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH"
          crossorigin="anonymous">
    <!-- Bootstrap 5 图标 -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" rel="stylesheet">
    <style>
        .comment-item {
            margin-bottom: 15px;
            padding: 15px;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            background-color: #fff;
        }
        .comment-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }
        .comment-book {
            color: #6a11cb;
            font-weight: 500;
        }
        .comment-date {
            color: #6c757d;
            font-size: 0.85rem;
        }
        .comment-content {
            margin-bottom: 10px;
        }
        .comment-actions {
            display: flex;
            gap: 10px;
        }
        .no-comments {
            text-align: center;
            padding: 40px;
            color: #6c757d;
            font-style: italic;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>个人中心</h1>
        
        <div class="profile-card">
            <div class="profile-info">
                <h2 th:text="${user.username}">用户名</h2>
                <p><strong>邮箱：</strong><span th:text="${user.email}"></span></p>
                <p><strong>昵称：</strong><span th:text="${user.nickname != null ? user.nickname : '未设置'}"></span></p>
                <p><strong>注册时间：</strong><span th:text="${user.createdAt}"></span></p>
            </div>
        </div>
        
        <!-- 我的评论区域 -->
        <div class="my-comments-section mt-8">
            <h3 class="section-title">我的评论</h3>
            
            <!-- 评论列表 -->
            <div th:if="${not #lists.isEmpty(myComments)}">
                <div th:each="comment : ${myComments}" class="comment-item">
                    <div class="comment-meta">
                        <span class="comment-book">
                            <a th:href="@{/books/{id}(id=${comment.book.id})}" th:text="${comment.book.title}"></a>
                        </span>
                        <span class="comment-date" th:text="${#temporals.format(comment.createdAt, 'yyyy-MM-dd HH:mm')}"></span>
                    </div>
                    <div class="comment-content" th:text="${comment.content}"></div>
                    
                    <!-- 评论是回复的情况 -->
                    <div th:if="${comment.parent != null}" class="mt-2">
                        <small class="text-muted">
                            <span>回复 @<span th:text="${comment.parent.user?.username}"></span></span>
                        </small>
                    </div>
                    
                    <!-- 操作按钮 - 修复管理员权限判断 -->
                    <div class="comment-actions" sec:authorize="isAuthenticated() and (${comment.user?.username} == authentication.name or hasRole('ADMIN'))">
                        <form method="post" th:action="@{/comments/{commentId}(commentId=${comment.id})}" 
                              th:onsubmit="|return confirm('确定删除此评论？此操作不可恢复。');|" class="d-inline">
                            <input type="hidden" name="_method" value="DELETE" />
                            <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
                            <input type="hidden" name="redirectUrl" th:value="@{/profile}" />
                            <button type="submit" class="btn btn-sm btn-outline-danger">
                                <i class="bi bi-trash"></i> 删除
                            </button>
                        </form>
                    </div>
                </div>
            </div>
            
            <!-- 无评论提示 -->
            <div th:unless="${not #lists.isEmpty(myComments)}" class="no-comments">
                <p>暂无评论记录</p>
            </div>
        </div>
        
        <!-- 返回按钮 -->
        <div class="mt-8 text-center">
            <a th:href="@{/books}" class="btn btn-primary">返回书籍列表</a>
        </div>
    </div>
    
    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
            integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
            crossorigin="anonymous"></script>
</body>
</html>