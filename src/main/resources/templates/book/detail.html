<!DOCTYPE html>
<html lang="zh-CN" xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title th:text="${book.title} + ' - ä¹¦ç±è¯¦æƒ…'">ä¹¦ç±è¯¦æƒ… - ä¹¦ç±ç®¡ç†ç³»ç»Ÿ</title>
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
          rel="stylesheet"
          integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH"
          crossorigin="anonymous">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background: linear-gradient(135deg, #6a11cb 0%, #2575fc 100%);
            min-height: 100vh;
            color: #333;
            padding-top: 70px; /* ä¸ºå›ºå®šå¯¼èˆªæ ç•™å‡ºç©ºé—´ */
        }

        .content-container {
            background-color: rgba(255, 255, 255, 0.95);
            margin-top: 20px;
            margin-bottom: 20px;
            padding: 30px;
            border-radius: 16px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }

        .book-cover-large {
            height: 400px;
            display: flex;
            justify-content: center;
            align-items: center;
            background-color: #f8f9fa;
            border-radius: 8px;
        }

        .book-cover-large img {
            max-height: 100%;
            max-width: 100%;
            object-fit: contain;
        }

        .book-info {
            margin-top: 20px;
        }

        .book-detail-title {
            font-size: 2rem;
            margin-bottom: 10px;
            background: linear-gradient(135deg, #6a11cb 0%, #2575fc 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .book-meta {
            margin-bottom: 20px;
            font-size: 1.1rem;
            color: #666;
        }

        .book-description {
            font-size: 1.1rem;
            line-height: 1.8;
            margin-bottom: 30px;
        }

        .action-btn {
            background: linear-gradient(135deg, #6a11cb 0%, #2575fc 100%);
            border: none;
            color: white;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 1.1rem;
            transition: opacity 0.3s ease;
            margin-right: 10px;
            margin-bottom: 10px;
        }

        .action-btn:hover {
            opacity: 0.9;
            color: white;
        }

        .comment-section {
            margin-top: 40px;
            padding-top: 30px;
            border-top: 1px solid #e0e0e0;
        }
        .comment-card {
            border: 1px solid rgba(16,24,40,0.06);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 18px;
            background-color: #ffffff;
            box-shadow: 0 6px 18px rgba(16,24,40,0.03);
        }

        .comment-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .comment-author {
            font-weight: bold;
        }

        .comment-time {
            color: #888;
            font-size: 0.9rem;
        }

        .comment-content {
            line-height: 1.6;
        }
        
        /* å¯¼èˆªæ æ ·å¼ */
        .navbar {
            background: linear-gradient(135deg, #6a11cb 0%, #2575fc 100%) !important;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 1000;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }
        
        .navbar-brand {
            color: white !important;
            font-weight: bold;
            font-size: 1.5rem;
        }
        
        .nav-link {
            color: white !important;
            font-weight: 500;
            transition: color 0.3s ease;
        }
        
        .nav-link:hover {
            color: rgba(255, 255, 255, 0.8) !important;
        }
        
        .nav-link.active {
            color: white !important;
            font-weight: bold;
            border-bottom: 2px solid white;
        }
        
        /* ä¸‹æ‹‰èœå•æ ·å¼ */
        .dropdown-menu {
            background-color: white;
            border: none;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }
        
        .dropdown-item {
            color: #333;
            padding: 10px 20px;
            transition: background-color 0.3s ease;
        }
        
        .dropdown-item:hover {
            background-color: #f8f9fa;
        }
        
        /* è¯„è®ºäº¤äº’æ ·å¼ */
        .comment-actions {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-top: 10px;
        }
        
        .comment-action {
            margin-right: 8px;
            display: inline-block;
            transition: color 0.3s ease;
        }
        
        .comment-action:hover {
            color: #6a11cb;
        }
        
        /* `.liked` will be styled below to match bootstrap primary for selected likes */
        
        /* å›å¤æ ·å¼ */
        .replies-container {
            margin-left: 30px;
            margin-top: 15px;
            padding-left: 15px;
            border-left: 2px solid #e0e0e0;
        }
        
        .reply-card {
            background-color: #fafafb;
            border-radius: 10px;
            padding: 12px 15px;
            margin-bottom: 12px;
            box-shadow: 0 4px 10px rgba(16,24,40,0.02);
        }

        /* Indent nested comment cards by level classes */
        .comment-card.reply-level-1 { margin-left: 30px; }
        .comment-card.reply-level-2 { margin-left: 48px; }
        .comment-card.reply-level-3 { margin-left: 64px; }
        .comment-card.reply-level-4 { margin-left: 80px; }
        
        .reply-form {
            margin-top: 10px;
            display: none;
            background-color: #ffffff;
            border-radius: 10px;
            padding: 12px;
            border: 1px solid rgba(16,24,40,0.04);
            max-width: 720px;
            transition: box-shadow 0.15s ease, transform 0.12s ease, max-height 0.12s ease;
            overflow: hidden;
        }

        .reply-form.show {
            display: block;
            box-shadow: 0 10px 30px rgba(16,24,40,0.06);
            transform: translateY(0px);
            max-height: 500px;
        }

        .comment-actions .btn {
            padding: 4px 10px;
            font-size: 0.9rem;
            border-radius: 6px;
        }

        .reply-form .form-control {
            border-radius: 8px;
            min-height: 48px;
            resize: vertical;
        }

        .reply-form .btn.action-btn {
            padding: 8px 22px;
            border-radius: 12px;
            background: linear-gradient(135deg, #6a11cb 0%, #2575fc 100%);
            border: none;
            color: #fff;
        }

        .reply-form .cancel-reply {
            padding: 6px 12px;
            border-radius: 8px;
            background-color: #6c757d;
            color: #fff;
            border: none;
        }

        /* æ–°å¢ï¼šç‚¹èµä¸åˆ é™¤æ ·å¼è¡¥å…… */
        .liked {
            color: white !important;
            background-color: #0d6efd !important; /* bootstrap primary */
            border-color: #0d6efd !important;
        }
        .like-btn.liked {
            background-color: #0d6efd !important;
            color: #fff !important;
            border-color: #0d6efd !important;
        }
        .like-btn .badge {
            background: rgba(255,255,255,0.95) !important;
            color: #0d6efd !important;
        }
        /* reply form alignment: main comment's reply form full width, reply's form indented */
        .comment-card > .reply-form {
            margin-left: 0;
            max-width: 100%;
        }

        .reply-card > .reply-form {
            margin-left: 64px;
            max-width: calc(100% - 64px);
        }
    </style>
</head>
<body>
    <!-- å¯¼èˆªæ ç›´æ¥åµŒå…¥é¡µé¢ï¼Œå¹¶æ·»åŠ ä¸ªäººèµ„æ–™å…¥å£ -->
    <nav class="navbar navbar-expand-lg navbar-light">
        <div class="container">
            <a class="navbar-brand" href="/">ğŸ“š ä¹¦ç±ç®¡ç†ç³»ç»Ÿ</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" 
                    data-bs-target="#navbarNav" aria-controls="navbarNav" 
                    aria-expanded="false" aria-label="åˆ‡æ¢å¯¼èˆª">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="/">é¦–é¡µ</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/books">ä¹¦ç±åˆ—è¡¨</a>
                    </li>
                    
                    <!-- ç®¡ç†å‘˜ç”¨æˆ·ç®¡ç†é“¾æ¥ - ä»…ç®¡ç†å‘˜å¯è§ï¼Œä½¿ç”¨ä¸‹æ‹‰èœå• -->
                    <li class="nav-item dropdown" sec:authorize="hasRole('ADMIN')">
                        <a class="nav-link dropdown-toggle" href="#" id="adminDropdown"
                           role="button" data-bs-toggle="dropdown" aria-expanded="false">
                            admin â–¼
                        </a>
                        <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="adminDropdown">
                            <li>
                                <a class="dropdown-item" href="/admin/users">ğŸ‘¥ ç”¨æˆ·ç®¡ç†</a>
                            </li>
                            <li>
                                <a class="dropdown-item" href="/admin/books">ğŸ“š ä¹¦ç±ç®¡ç†</a>
                            </li>
                            <li>
                                <a class="dropdown-item" href="/admin/categories">ğŸ·ï¸ åˆ†ç±»ç®¡ç†</a>
                            </li>
                        </ul>
                    </li>
                    
                    <!-- æœªç™»å½•æ—¶æ˜¾ç¤ºç™»å½•/æ³¨å†Œ -->
                    <li class="nav-item" sec:authorize="!isAuthenticated()">
                        <a class="nav-link" href="/login">ç™»å½•</a>
                    </li>
                    <li class="nav-item" sec:authorize="!isAuthenticated()">
                        <a class="nav-link" href="/register">æ³¨å†Œ</a>
                    </li>
                    
                    <!-- å·²ç™»å½•æ—¶æ˜¾ç¤ºç”¨æˆ·ä¿¡æ¯å’Œä¸ªäººèµ„æ–™å…¥å£ -->
                    <li class="nav-item dropdown" sec:authorize="isAuthenticated() and !hasRole('ADMIN')">
                        <a class="nav-link dropdown-toggle" href="#" id="userDropdown"
                           role="button" data-bs-toggle="dropdown" aria-expanded="false">
                            <span sec:authentication="name"></span>
                        </a>
                        <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="userDropdown">
                            <li>
                                <a class="dropdown-item" href="/user/profile">ä¸ªäººèµ„æ–™</a>
                            </li>
                            <li>
                                <a class="dropdown-item" href="/user/edit-profile">ç¼–è¾‘èµ„æ–™</a>
                            </li>
                            <li>
                                <a class="dropdown-item" href="/user/password">ä¿®æ”¹å¯†ç </a>
                            </li>
                            <li>
                                <a class="dropdown-item" href="/user/favorites">æˆ‘çš„æ”¶è—</a>
                            </li>
                            <li>
                                <form th:action="@{/logout}" method="post" style="margin: 0;">
                                    <button type="submit" class="dropdown-item">é€€å‡ºç™»å½•</button>
                                </form>
                            </li>
                        </ul>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container">
        <div class="content-container">
            <div class="row">
                <!-- ä¹¦ç±å°é¢ -->
                <div class="col-md-4">
                    <div class="book-cover-large">
                        <img th:src="${book.coverImage != null ? book.coverImage : '/images/default-cover.jpg'}"
                             alt="ä¹¦ç±å°é¢" class="img-fluid">
                    </div>
                </div>
                
                <!-- ä¹¦ç±ä¿¡æ¯ -->
                <div class="col-md-8 book-info">
                    <h1 class="book-detail-title" th:text="${book.title}"></h1>
                    
                    <div class="book-meta">
                        <p><strong>ä½œè€…ï¼š</strong><span th:text="${book.author}"></span></p>
                        <!-- <p><strong>ISBNï¼š</strong><span th:text="${book.isbn != null ? book.isbn : ''}"></span></p>
                        <p><strong>å‡ºç‰ˆç¤¾ï¼š</strong><span th:text="${book.publisher != null ? book.publisher : ''}"></span></p>
                        <p><strong>å‡ºç‰ˆå¹´ä»½ï¼š</strong><span th:text="${book.year != null ? book.year : ''}"></span></p> -->
                        <p><strong>åˆ†ç±»ï¼š</strong><span th:text="${book.category != null ? book.category.name : ''}"></span></p>
                    </div>
                    
                    <div class="book-description">
                        <p th:text="${book.description}"></p>
                    </div>
                    
                    <!-- æ“ä½œæŒ‰é’® -->
                    <div>
                        <a href="/books" class="btn action-btn">è¿”å›åˆ—è¡¨</a>
                        
                        <!-- ä»…ç®¡ç†å‘˜å¯è§çš„ç¼–è¾‘æŒ‰é’® -->
                        <a th:href="@{/admin/books/{id}/edit(id=${book.id})}"
                           class="btn action-btn"
                           sec:authorize="hasRole('ADMIN')">
                            ç¼–è¾‘ä¹¦ç±
                        </a>
                        
                        <!-- æ”¶è—/å–æ¶ˆæ”¶è—æŒ‰é’®ï¼Œä»…ç™»å½•ç”¨æˆ·å¯è§ -->
                        <form th:action="@{${isFavorite ? '/books/' + book.id + '/unfavorite' : '/books/' + book.id + '/favorite'}}" method="post"
                            class="d-inline-block"
                            sec:authorize="isAuthenticated()">
                            <button type="submit" class="btn action-btn"
                                    th:classappend="${isFavorite ? 'btn-secondary' : ''}">
                                <span th:text="${isFavorite ? 'å–æ¶ˆæ”¶è—' : 'åŠ å…¥æ”¶è—'}"></span>
                            </button>
                        </form>
                    </div>
                </div>
            </div>
            
            <!-- è¯„è®ºåŒºåŸŸ -->
            <div class="comment-section">
                <h2 class="mb-4">ğŸ’¬ è¯»è€…è¯„è®º</h2>
                
                <!-- å‘è¡¨è¯„è®ºè¡¨å•ï¼Œä»…ç™»å½•ç”¨æˆ·å¯è§ -->
                <div sec:authorize="isAuthenticated()" class="mb-4">
                    <form th:action="@{/books/{id}/comments(id=${book.id})}" method="post">
                        <div class="mb-3">
                            <label for="comment" class="form-label">å‘è¡¨è¯„è®ºï¼š</label>
                            <textarea id="comment" name="content" class="form-control"
                                      rows="3" required></textarea>
                        </div>
                        <button type="submit" class="btn action-btn">æäº¤è¯„è®º</button>
                    </form>
                </div>
                
                <!-- è¯„è®ºåˆ—è¡¨ -->
                <div th:if="${comments != null and !comments.isEmpty()}">
                    <!-- é€’å½’æ¸²æŸ“æ³¨é‡ŠèŠ‚ç‚¹ -->
                    <th:block th:fragment="commentNode (comment, level)">
                        <div class="comment-card" th:if="${comment != null}" th:classappend="${level > 0} ? ' reply-level-' + ${level} : ''">
                            <div class="comment-header">
                                <span class="comment-author" th:text="${comment != null and comment.user != null ? comment.user.username : 'åŒ¿åç”¨æˆ·'}"></span>
                                <span class="comment-time" th:text="${comment.createdAt != null ? #temporals.format(comment.createdAt, 'yyyy-MM-dd HH:mm:ss') : ''}"></span>
                            </div>
                            <div class="comment-content" th:text="${comment.content}"></div>
                            <div class="comment-actions">
                                <form th:action="@{/comments/{commentId}/like(commentId=${comment.id})}" method="post" class="d-inline">
                                    <input type="hidden" name="redirectUrl" th:value="@{/books/{id}(id=${book.id})}">
                                    <button type="submit" class="btn btn-sm btn-outline-primary like-btn me-1" th:classappend="${comment.isLikedByUsername(#authentication != null ? #authentication.name : null) ? ' liked' : ''}">
                                        <span>ğŸ‘</span>
                                        <span class="badge bg-light text-dark ms-1 rounded-pill" th:text="${comment.likeCount}">0</span>
                                    </button>
                                </form>

                                <button type="button" class="btn btn-sm btn-outline-secondary reply-btn" th:attr="data-comment-id=${comment.id}" sec:authorize="isAuthenticated()">å›å¤</button>

                                <form th:action="@{/comments/{id}(id=${comment.id})}" method="post" class="d-inline" 
                                      th:if="${#authentication != null and (#authentication.name == (comment != null and comment.user != null ? comment.user.username : '') or #authorization.expression('hasRole(''ADMIN'')'))}">
                                    <input type="hidden" name="_method" value="DELETE">
                                    <input type="hidden" name="redirectUrl" th:value="@{/books/{id}(id=${book.id})}">
                                    <button type="submit" class="btn btn-sm btn-outline-danger">åˆ é™¤</button>
                                </form>
                            </div>

                            <!-- å›å¤è¡¨å• -->
                            <div class="reply-form" th:id="'reply-form-' + ${comment.id}">
                                <form th:action="@{/books/{bookId}/comments/{parentId}/reply(bookId=${book.id}, parentId=${comment.id})}" method="post">
                                    <div class="mb-2">
                                        <textarea name="content" class="form-control" rows="2" required placeholder="å†™ä¸‹ä½ çš„å›å¤..."></textarea>
                                    </div>
                                    <button type="submit" class="btn btn-sm action-btn">å›å¤</button>
                                    <button type="button" class="btn btn-sm cancel-reply" th:attr="data-comment-id=${comment.id}">å–æ¶ˆ</button>
                                </form>
                            </div>

                            <!-- å­å›å¤ -->
                            <div class="replies-container" th:if="${comment.replies != null and !comment.replies.empty}">
                                <div th:each="reply : ${comment.replies}">
                                    <th:block th:insert="~{this :: commentNode(comment=${reply}, level=${level + 1})}"></th:block>
                                </div>
                            </div>
                        </div>
                    </th:block>

                    <!-- æ¸²æŸ“æ‰€æœ‰æ ¹è¯„è®ºï¼šCommentService å·²è¿”å› root åˆ—è¡¨å¹¶å¡«å…… replies -->
                        <div th:each="comment : ${comments}">
                            <th:block th:insert="~{this :: commentNode(comment=${comment}, level=${0})}"></th:block>
                        </div>
                </div>
                
                <!-- æ— è¯„è®ºæ—¶çš„æç¤º -->
                <div th:if="${comments == null or comments.isEmpty()}" class="text-center py-5">
                    <p class="text-muted">æš‚æ— è¯„è®ºï¼Œæ¥å‘è¡¨ç¬¬ä¸€æ¡è¯„è®ºå§ï¼</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap 5 JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
            integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
            crossorigin="anonymous"></script>
            
    <!-- è¯„è®ºäº¤äº’è„šæœ¬ -->
    <script>
        // äº‹ä»¶å§”æ‰˜ï¼šåœ¨è¯„è®ºåŒºå®¹å™¨ä¸Šç›‘å¬ç‚¹å‡»ï¼Œå¤„ç†å›å¤ä¸å–æ¶ˆæŒ‰é’®ï¼Œæ”¯æŒåŠ¨æ€æ·»åŠ çš„å…ƒç´ 
        document.querySelectorAll('.comment-section').forEach(container => {
            container.addEventListener('click', function(event) {
                const target = event.target;
                const replyBtn = target.closest('.reply-btn');
                if (replyBtn) {
                    const commentId = replyBtn.getAttribute('data-comment-id');
                    const replyForm = document.getElementById(`reply-form-${commentId}`);
                    if (replyForm) {
                        replyForm.classList.toggle('show');
                        const ta = replyForm.querySelector('textarea');
                        if (ta) ta.focus();
                    }
                    return;
                }

                const cancelBtn = target.closest('.cancel-reply');
                if (cancelBtn) {
                    const commentId = cancelBtn.getAttribute('data-comment-id');
                    const replyForm = document.getElementById(`reply-form-${commentId}`);
                    if (replyForm) replyForm.classList.remove('show');
                    return;
                }
            });
        });
        
        // ä½¿ç”¨Bootstrapå†…ç½®çš„Dropdownç»„ä»¶åˆå§‹åŒ–ä¸‹æ‹‰èœå•ï¼ˆé¿å…è‡ªå®šä¹‰äº‹ä»¶é˜»æ–­Bootstrapè¡Œä¸ºï¼‰
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof bootstrap !== 'undefined' && bootstrap.Dropdown) {
                const dropdownToggles = document.querySelectorAll('.dropdown-toggle');
                dropdownToggles.forEach(function(toggleEl) {
                    try {
                        new bootstrap.Dropdown(toggleEl);
                    } catch (e) {
                        // å¿½ç•¥åˆå§‹åŒ–å¼‚å¸¸ï¼Œä¿æŒé¡µé¢å¯ç”¨æ€§
                        console.error('Dropdown init failed', e);
                    }
                });
            }
        });
    </script>
</body>
</html>